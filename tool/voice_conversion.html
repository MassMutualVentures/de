<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>语音转写 + 中文翻译（转写后自动清理）</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; }
  .card { border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin:12px 0; }
  .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  .out { white-space:pre-wrap; border:1px solid #e5e7eb; border-radius:10px; padding:12px; min-height:84px; }
  .hint { color:#6b7280; font-size:13px; }
  button { padding:10px 16px; border-radius:10px; border:1px solid #e5e7eb; background:#111827; color:#fff; cursor:pointer; }
  button[disabled]{opacity:.6; cursor:not-allowed;}
</style>
</head>
<body>
<h1>语音转写 + 中文翻译</h1>

<div class="card">
  <div class="row">
    <input id="audio" type="file" accept="audio/*,video/*">
    <select id="lang">
      <option value="">自动识别</option>
      <option value="en">英语</option>
      <option value="de">德语</option>
      <option value="zh">中文</option>
      <option value="ja">日语</option>
      <option value="ko">韩语</option>
    </select>
    <button id="go">提交</button>
  </div>
  <div class="row"><span id="status" class="hint"></span></div>
</div>

<div class="card">
  <h3>原文（转写结果）</h3>
  <div id="result" class="out">等待上传...</div>
</div>

<div class="card">
  <h3>中文翻译</h3>
  <div id="cn" class="out">等待上传...</div>
</div>

<script>
const API_BASE = "https://api.massmutualventures.de";
const el = {
  file: document.getElementById('audio'),
  lang: document.getElementById('lang'),
  go: document.getElementById('go'),
  status: document.getElementById('status'),
  out1: document.getElementById('result'),
  out2: document.getElementById('cn')
};

function setStatus(t){ el.status.textContent = t || ""; }

async function transcribe(file, language){
  const fd = new FormData();
  fd.append("file", file);
  fd.append("model", "whisper-1");
  fd.append("response_format", "text");
  if (language) fd.append("language", language);

  const r = await fetch(`${API_BASE}/v1/audio/transcriptions`, { method:"POST", body: fd });
  if (!r.ok) throw new Error(`转写失败：${r.status} ${r.statusText}\n${await r.text().catch(()=> "")}`);
  const text = await r.text();

  // —— 关键点：用完就“删除/清理” —— //
  // 1) 移除 FormData 中的文件引用
  try { fd.delete("file"); } catch {}
  // 2) 置空本地变量的引用，让 GC 可以回收
  // （JS 无法“擦除”用户磁盘上的选中文件，这一步是释放内存引用）
  return text;
}

async function translateToZH(text){
  const r = await fetch(`${API_BASE}/v1/chat/completions`, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({
      model: "gpt-4o-mini",
      messages: [
        { role: "system", content: "把用户输入的文本准确翻译成简体中文；若文本已是中文则原样返回。" },
        { role: "user", content: text }
      ],
      temperature: 0.2
    })
  });
  if (!r.ok) throw new Error(`翻译失败：${r.status} ${r.statusText}\n${await r.text().catch(()=> "")}`);
  const j = await r.json();
  return j?.choices?.[0]?.message?.content ?? "";
}

el.go.addEventListener('click', async () => {
  if (!el.file.files.length) return alert("请先选择一个音/视频文件");
  let fileRef = el.file.files[0];

  el.go.disabled = true;
  el.out1.textContent = "正在转写...";
  el.out2.textContent = "等待转写完成...";
  setStatus("上传并转写中...");

  try {
    const lang = el.lang.value || undefined;
    // 转写
    const text = await transcribe(fileRef, lang);
    el.out1.textContent = text || "(空)";
    setStatus("转写完成，正在翻译...");

    // 翻译
    const zh = await translateToZH(text);
    el.out2.textContent = zh || "(空)";
    setStatus("完成 ✅");
  } catch (e) {
    console.error(e);
    el.out1.textContent = `错误：${e?.message || e}`;
    el.out2.textContent = "";
    setStatus("出错");
  } finally {
    // —— 关键点：释放/“删除”上传文件引用 —— //

    // 1) 清空 <input type="file">，浏览器不再保留用户选中文件的引用
    el.file.value = "";

    // 2) 置空局部变量中的 File 引用
    try { fileRef = null; } catch {}

    // 3) 如果你曾经用 URL.createObjectURL() 预览，需要 revoke（我们这里没用）
    // URL.revokeObjectURL(objectUrl);

    el.go.disabled = false;
  }
});
</script>
</body>
</html>
