<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>语音转写 + 中文翻译（通过自有代理）</title>
<style>
  :root { --bd:#e5e7eb; --fg:#111827; --muted:#6b7280; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei"; color:var(--fg); margin:24px; }
  h1 { margin: 0 0 12px; }
  .card { border:1px solid var(--bd); border-radius:12px; padding:16px; margin:12px 0; }
  .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  input[type="file"] { padding:8px 0; }
  button { padding:10px 16px; border-radius:10px; border:1px solid var(--bd); background:#111827; color:#fff; cursor:pointer; }
  button[disabled] { opacity:.6; cursor:not-allowed; }
  label { font-size:14px; color:var(--muted); }
  .out { white-space:pre-wrap; border:1px solid var(--bd); border-radius:10px; padding:12px; min-height:80px; }
  .hint { color:var(--muted); font-size:13px; }
  progress { width:240px; height:10px; }
</style>
</head>
<body>
  <h1>语音转写 + 中文翻译</h1>
  <div class="card">
    <div class="row">
      <input id="audio" type="file" accept="audio/*,video/*" />
      <select id="lang">
        <option value="">自动识别</option>
        <option value="en">英语</option>
        <option value="de">德语</option>
        <option value="zh">中文</option>
        <option value="ja">日语</option>
        <option value="ko">韩语</option>
        <!-- 需要其它可自行添加 ISO 639-1 语言码 -->
      </select>
      <button id="go">提交转写并翻译</button>
      <span class="hint">通过 <code>https://api.massmutualventures.de</code> 代理到 OpenAI，无需暴露密钥</span>
    </div>
    <div class="row" style="margin-top:8px">
      <label><input type="checkbox" id="translateOnlyIfEnglish" checked> 仅当原文是英文才翻译为中文</label>
    </div>
    <div class="row" style="margin-top:8px">
      <progress id="prog" max="100" value="0" hidden></progress>
      <span id="status" class="hint"></span>
    </div>
  </div>

  <div class="card">
    <h3>原文（转写结果）</h3>
    <div id="result" class="out">等待上传...</div>
  </div>

  <div class="card">
    <h3>中文翻译</h3>
    <div id="cn" class="out">等待上传...</div>
  </div>

<script>
const API_BASE = "https://api.massmutualventures.de"; // 你的代理
const btn = document.getElementById("go");
const fileInput = document.getElementById("audio");
const langSel = document.getElementById("lang");
const statusEl = document.getElementById("status");
const prog = document.getElementById("prog");
const outOriginal = document.getElementById("result");
const outCN = document.getElementById("cn");
const translateOnlyIfEnglish = document.getElementById("translateOnlyIfEnglish");

// 简单的进度展示（注：fetch 不会给上传进度，这里只做阶段指示）
function setStage(text, p = null) {
  statusEl.textContent = text || "";
  if (p === null) { prog.hidden = true; }
  else { prog.hidden = false; prog.value = p; }
}

async function transcribe(file, language) {
  const fd = new FormData();
  fd.append("file", file);
  fd.append("model", "whisper-1");
  fd.append("response_format", "verbose_json"); // 带语言与段落信息
  if (language) fd.append("language", language);

  const r = await fetch(`${API_BASE}/v1/audio/transcriptions`, { method: "POST", body: fd });
  if (!r.ok) {
    const txt = await r.text().catch(()=> "");
    throw new Error(`转写失败：${r.status} ${r.statusText}\n${txt}`);
  }
  return r.json();
}

async function translateToChinese(text) {
  const r = await fetch(`${API_BASE}/v1/chat/completions`, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({
      model: "gpt-4o-mini",
      messages: [
        { role: "system", content: "你是专业的翻译助手。把输入文本忠实、流畅地翻译成简体中文；保留术语与人名；若文本已是中文则原样返回。" },
        { role: "user", content: text }
      ],
      temperature: 0.2
    })
  });
  if (!r.ok) {
    const txt = await r.text().catch(()=> "");
    throw new Error(`翻译失败：${r.status} ${r.statusText}\n${txt}`);
  }
  const j = await r.json();
  return j?.choices?.[0]?.message?.content ?? "";
}

btn.addEventListener("click", async () => {
  const f = fileInput.files?.[0];
  if (!f) { alert("请先选择一个音频或视频文件"); return; }

  btn.disabled = true;
  outOriginal.textContent = "正在转写...";
  outCN.textContent = "等待转写完成...";
  setStage("上传中...", 10);

  try {
    // 1) 语音转写
    const lang = langSel.value.trim();
    const tr = await transcribe(f, lang || undefined);
    setStage("转写完成，处理结果...", 60);

    // OpenAI verbose_json 里常见字段：text / language / duration / segments[]
    const transcriptText = tr?.text || "";
    const detectedLang = tr?.language || "(unknown)";
    outOriginal.textContent = transcriptText || "(空)";

    // 2) 是否需要中文翻译
    // 如果“仅当原文是英文才翻译”且检测语言不是英语，就直接把原文填到中文区域
    if (translateOnlyIfEnglish.checked && detectedLang && detectedLang.toLowerCase() !== "en") {
      setStage(`检测语言：${detectedLang}，已跳过翻译`, 100);
      outCN.textContent = transcriptText || "(空)";
    } else {
      setStage("请求中文翻译...", 80);
      const zh = await translateToChinese(transcriptText);
      outCN.textContent = zh || "(空)";
      setStage("完成 ✅", 100);
    }
  } catch (err) {
    console.error(err);
    outOriginal.textContent = `错误：${err?.message || err}`;
    outCN.textContent = "";
    setStage("出错", null);
  } finally {
    btn.disabled = false;
  }
});
</script>
</body>
</html>
